# syntax = docker/dockerfile:1

ARG NODE_VERSION=22.17.1
FROM node:${NODE_VERSION}-slim AS base

WORKDIR /app
ENV NODE_ENV="production"

FROM base AS build
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y build-essential node-gyp pkg-config python-is-python3

# package.json / lockfile ë³µì‚¬
COPY client/package-lock.json client/package.json ./

# ğŸ”‘ peer dependency ì¶©ëŒ ë¬´ì‹œ
RUN npm ci --include=dev --legacy-peer-deps

# ì•± ì†ŒìŠ¤ ë³µì‚¬
COPY client/ .

# Next.js ë¹Œë“œ
RUN npx next build --experimental-build-mode compile

# ğŸ”‘ prune ì‹œì—ë„ ì¶©ëŒ ë¬´ì‹œ
RUN npm prune --omit=dev --legacy-peer-deps || true

FROM base
COPY --from=build /app /app

EXPOSE 3000
CMD ["npx", "next", "start", "-p", "3000", "-H", "0.0.0.0"]
